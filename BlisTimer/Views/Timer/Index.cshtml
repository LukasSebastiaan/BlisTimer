@model Dictionary<Tuple<BlisTimer.Models.Project, bool>, List<WorkActivity>>

@{
  ViewData["Title"] = "Stopwatch Page";
  Layout = "_HomeLayout";
}

@section head{
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
}
@section scripts {
  <script type="text/javascript">
    // Globals
    const time_el = document.querySelector('.watch .time');
    const startButton = document.getElementById("start");
    const stopButton = document.getElementById("stop");
    const pauseButton = document.getElementById("pause");

    let seconds = 0;
    let interval = null;

    // Event Listeners
    startButton.addEventListener('click', start);
    stopButton.addEventListener('click', stop);
    pauseButton.addEventListener('click', pause);


    // Timer updates
    function timer() {
      seconds++;

      //Format the time 
      let hrs = Math.floor(seconds / 3600);
      let mins = Math.floor((seconds - (hrs * 3600)) / 60);
      let secs = seconds % 60;

      if (secs < 10) secs = "0" + secs;
      if (mins < 10) mins = "0" + mins;
      if (hrs < 10) hrs = "0" + hrs;

      time_el.innerText = `${hrs}:${mins}:${secs}`;	
    }
    
    //start button
    function start() {
      if (interval) {
        return;
      }

      interval = setInterval(timer, 1000);
    }

    //pause button
    function pause() {
      clearInterval(interval);
      interval = null;
}

    //stop button
    function stop() {
      if(seconds > 0){
        clearInterval(interval);
        interval = null;
    
        openPopup();
      }
    }

    //confirm button
    function confirm() {
      closePopup();
      seconds = 0;
      time_el.innerText = "00:00:00";
    }

    //cancel button
    function cancel() {
      closePopup();
      start();
    }


    //Popup message
    let popup = document.getElementById("popup");

    function openPopup() {
      popup.classList.add("open-popup");
    }

    function closePopup() {
      popup.classList.remove("open-popup");
    }
    
    function submitProjectId(){
        let p = document.getElementById("project");
        console.log(p)
        document.forms[0].Id.value = p.value 
        document.forms[0].submit()
    }
    function submitActivityId(){
        let p = document.getElementById("activity");
        console.log(p)
        document.forms[1].Id.value = p.value 
        document.forms[1].submit()
    }
    function submitHourTypeId(){
        let p = document.getElementById("hourtype");
        console.log(p)
        document.forms[2].Id.value = p.value 
        document.forms[2].submit()
    }
    
    </script>

}


<div id="screen">
  <div class="watch">
    <div class="task">
      <form method="post" id="projects" asp-action="Index" asp-controller="Timer">
        <input type="hidden" name="Id" value="givenProject">
        <select name="Project" id="project" onchange="submitProjectId()">
          @if (!@ViewBag.preSelectedProject)
          {
            <option selected disabled hidden>Select a Project</option>
            @foreach (var project in @Model)
            {
              <option value="@project.Key.Item1.Id">@project.Key.Item1.Name</option>
            }
          }
          @if (@ViewBag.PreSelectedProject)
          {
            @foreach (var Selectedproject in @Model)
            {
              if (Selectedproject.Key.Item2 == true)
              {
                <option value="@Selectedproject.Key.Item1.Id">@Selectedproject.Key.Item1.Name</option>
              }
            }
            @foreach (var project in @Model)
            {
              if (project.Key.Item2 == false)
              {
                <option value="@project.Key.Item1.Id">@project.Key.Item1.Name</option>
              }
            }
          }
        </select>
      </form>
      @if (@ViewBag.PreSelectedProject)
      {
        <form method="post" id="activitys" asp-action="Index2" asp-controller="Timer">
          <input type="hidden" name="Id" value="givenActivity">
          <select name="Activity" id="activity" onchange="submitActivityId()">
            @if (!@ViewBag.PreSelectedActivity)
            {
              <option selected disabled hidden>Select an Activity</option>
              @foreach (var Selectedproject in @Model)
              {
                if (Selectedproject.Key.Item2 == true)
                {
                  foreach (var activity in Selectedproject.Value)
                  {
                    <option value="@activity.Id">@activity.Name</option>
                  }
                }
              }


            }
            @if (@ViewBag.PreSelectedActivity)
            {
              @foreach (var Selectedproject in @Model)
              {
                if (Selectedproject.Key.Item2 == true)
                {

                  <option value="@ViewBag.PreSelectedActivityId">@ViewBag.PreSelectedActivityName</option>
                  foreach (var activity in Selectedproject.Value)
                  {
                    if (activity.Id != @ViewBag.PreSelectedActivityId)
                    {
                      <option value="@activity.Id">@activity.Name</option>
                    }
                  }
                }
              }
            }
          </select>
        </form>
        @if (@ViewBag.PreSelectedActivity)
        {
          <form method="post" id="hourtypes" asp-action="Index3" asp-controller="Timer">
            <input type="hidden" name="Id" value="givenHourType">
            <select name="HourType" id="hourtype" onchange="submitHourTypeId()">
              @if (!@ViewBag.PreSelectedHourType)
              {
                <option selected disabled hidden>Select an HourType</option>
                @foreach (var hourtype in @ViewBag.PreSelectedHourTypeList)
                {
                  <option value="@hourtype.HourTypeId">@hourtype.Label</option>
                } 
              }
              @if (@ViewBag.PreSelectedHourType)
              {
                @foreach (var hourtype in @ViewBag.PreSelectedHourTypeList)
                {
                  if (@ViewBag.PreSelectedHourTypeId == hourtype.HourTypeId)
                  {
                    <option value="@hourtype.HourTypeId">@hourtype.Label</option>
                  }
                } 
                @foreach (var hourtype in @ViewBag.PreSelectedHourTypeList)
                {
                  if (@ViewBag.PreSelectedHourTypeId != hourtype.HourTypeId)
                  {
                    <option value="@hourtype.HourTypeId">@hourtype.Label</option>
                  }
                } 
              }
            </select>
          </form>
        }
      }
    </div>

    <div class="time">
      00:00:00
    </div>

    <div class="controls">
      <button id="start">Start</button>
      <button id="stop">Stop</button>
    </div>

    <div class="controls">
      <button id="pause">Take a break</button>
    </div>

    <div class="popup" id="popup">
      <h2>Project > Current Task</h2>
      <p>Please confirm you have worked (Time) on this task.</p>
      <button type="button" class="btn" onclick="confirm()">Confirm</button>
      <button type="button" class="btn" onclick="cancel()">Cancel</button>
    </div>
  </div>
</div>
